<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Крестики-нолики</title>
    <style>    
    .game-container {
        width: 100%;
        max-width: 45vh; /* Сохраняем соотношение 9:16 */
        height: 80vh;
        margin: 0 auto;
        padding: 0px;
        background-color: #0058C9;
        font-family: 'PlutoOreo', Arial, sans-serif;
        color: #fff;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        position: relative; /* Добавлено для позиционирования внутренних элементов */
    }

    @font-face {
        font-family: 'PlutoOreo';
        src: url('https://cdn.jsdelivr.net/gh/timememe/o_files@main/PlutoOreo-Black.otf') format('opentype');
    }
    
    .cookie-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: auto;
        z-index: 1;
        pointer-events: none;
    }
    
    .logo {
        width: 100%;
        height: auto;
        max-width: 100%;
        margin-bottom: 20px;
    }

    .board-container {
        position: relative;
        width: 100%;
        max-width: 300px;
        aspect-ratio: 1 / 1;
        margin: auto;
    }
    
    .board_BG {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: url('https://cdn.jsdelivr.net/gh/timememe/o_files@main/cell_BG.png') no-repeat center center;
        background-size: cover;
        z-index: 2;
    }
    
    .board {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, 1fr);
        gap: 0%;
        background: url('https://cdn.jsdelivr.net/gh/timememe/o_files@main/cell.png') no-repeat center center;
        background-size: cover;
        z-index: 3;
    }
    
    .cell {
        width: 100%;
        height: 0;
        padding-bottom: 100%;
        background-size: cover;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        border: 2px solid #ffffff00;
        border-radius: 15px;
        transition: background-color 0.3s;
        position: relative;
    }
    
    .cell img {
        position: absolute;
        top: 10%;
        left: 10%;
        width: 80%;
        height: 80%;
    }
    
    .cell img.appear {
        animation: appear 0.5s ease-in-out;
    }
    
    @keyframes appear {
        from {
            transform: scale(0);
            opacity: 0;
        }
        to {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    .cell:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    button {
        padding: 10px 20px;
        font-size: 1rem;
        font-family: 'PlutoOreo';
        cursor: pointer;
        background-color: #0058C9;
        border: 2px solid #fff;
        color: #fff;
        border-radius: 25px;
        transition: background-color 0.3s;
    }
    
    button:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    .popup {
        position: absolute; /* Изменено с fixed на absolute */
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(8px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 20;
    }
    
    .popup-content {
        background-color: rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(8px);
        padding: 20px;
        border-radius: 60px;
        text-align: center;
        color: #ffffff;
        border: 10px solid #fff;
        max-width: 90%;
    }
    
    .popup-content h2 {
        margin-top: 0;
    }
    
    .popup-content button {
        padding: 10px 20px;
        font-size: 1rem;
        cursor: pointer;
        margin-top: 20px;
    }
    
    .tutorial-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin: 20px 0;
    }
    
    .tutorial-grid img {
        width: 100%;
        height: auto;
        border-radius: 5px;
    }
    </style>
</head>
<body>
    <div class="game-container">
        <img src="https://cdn.jsdelivr.net/gh/timememe/o_files@main/cookie_logo.png" alt="logo" class="logo">        
        <div id="popup" class="popup">
            <div class="popup-content">
                <h2>ИНСТРУКЦИЯ!</h2>
                <p>Соберите печеньки с кремом в одну линию! Собравший первым побеждает!</p>
                <div class="tutorial-grid">
                    <img src="https://cdn.jsdelivr.net/gh/timememe/o_files@main/tut1.png" alt="Tutorial 1">
                    <img src="https://cdn.jsdelivr.net/gh/timememe/o_files@main/tut2.png" alt="Tutorial 2">
                    <img src="https://cdn.jsdelivr.net/gh/timememe/o_files@main/tut3.png" alt="Tutorial 3">
                </div>
                <button id="start">Играть</button>
            </div>
        </div>
        <div id="win-popup" class="popup">
            <div class="popup-content">
                <h2 id="win-message"></h2>
                <p id="round-counter"></p>
                <button id="close-win-popup">Закрыть</button>
            </div>
        </div>
        <div id="final-popup" class="popup">
            <div class="popup-content">
                <h2 id="final-message"></h2>
                <button id="restart-game">Играть заново</button>
            </div>
        </div>
        <div class="board-container">            
            <div class="board_BG"></div>
            <div id="board" class="board">
                <div class="cell" data-index="0"></div>
                <div class="cell" data-index="1"></div>
                <div class="cell" data-index="2"></div>
                <div class="cell" data-index="3"></div>
                <div class="cell" data-index="4"></div>
                <div class="cell" data-index="5"></div>
                <div class="cell" data-index="6"></div>
                <div class="cell" data-index="7"></div>
                <div class="cell" data-index="8"></div>
            </div>
        </div>        
        <button id="restart">Сыграть снова</button>
    </div>
    <script>
        const board = document.getElementById('board');
        const cells = document.querySelectorAll('.cell');
        const restartButton = document.getElementById('restart');
        const popup = document.getElementById('popup');
        const winPopup = document.getElementById('win-popup');
        const finalPopup = document.getElementById('final-popup');
        const winMessage = document.getElementById('win-message');
        const roundCounterText = document.getElementById('round-counter');
        const finalMessage = document.getElementById('final-message');
        const closeWinPopupButton = document.getElementById('close-win-popup');
        const restartGameButton = document.getElementById('restart-game');
        const startButton = document.getElementById('start');
        
        let currentPlayer = 'X';
        let gameActive = false;
        let roundCounter = { player: 0, bot: 0, draw: 0 };
        let roundsPlayed = 0;
        
        const winningConditions = [
            [0, 1, 2],
            [3, 4, 5],
            [6, 7, 8],
            [0, 3, 6],
            [1, 4, 7],
            [2, 5, 8],
            [0, 4, 8],
            [2, 4, 6]
        ];
        
        const checkWin = (player) => {
            return winningConditions.some(condition => {
                return condition.every(index => {
                    return cells[index].dataset.player === player;
                });
            });
        };
        
        const checkDraw = () => {
            return [...cells].every(cell => {
                return cell.dataset.player === 'X' || cell.dataset.player === 'O';
            });
        };
        
        const showWinPopup = (message) => {
            winMessage.textContent = message;
            roundCounterText.innerHTML = `Счет:<br>Игрок: ${roundCounter.player}<br>ИИ: ${roundCounter.bot}<br>Ничья: ${roundCounter.draw}`;
            winPopup.style.display = 'flex';
        };
        
        const showFinalPopup = () => {
            finalMessage.innerHTML = `Итоги игры:<br>Игрок: ${roundCounter.player}<br>ИИ: ${roundCounter.bot}<br>Ничья: ${roundCounter.draw}`;
            finalPopup.style.display = 'flex';
        };
        
        const handleCellClick = (e) => {
            if (!gameActive) return;
        
            const cell = e.target;
            const cellIndex = parseInt(cell.getAttribute('data-index'));
        
            if (cell.dataset.player) {
                return;
            }
        
            cell.dataset.player = currentPlayer;
            cell.innerHTML = `<img src="https://cdn.jsdelivr.net/gh/timememe/o_files@main/back_${currentPlayer === 'X' ? 'cream' : 'nocream'}.png" alt="${currentPlayer}" class="appear">`;
        
            if (checkWin(currentPlayer)) {
                roundsPlayed++;
                roundCounter[currentPlayer === 'X' ? 'player' : 'bot']++;
                if (roundsPlayed >= 3) {
                    showFinalPopup();
                } else {
                    showWinPopup(`${currentPlayer} победил!`);
                }
                gameActive = false;
                return;
            }
        
            if (checkDraw()) {
                roundsPlayed++;
                roundCounter.draw++;
                if (roundsPlayed >= 3) {
                    showFinalPopup();
                } else {
                    showWinPopup('Ничья!');
                }
                gameActive = false;
                return;
            }
        
            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
        
            if (currentPlayer === 'O') {
                setTimeout(botMove, 500);  // Delay AI move by 500ms
            }
        };
        
        const botMove = () => {
            const emptyCells = [...cells].filter(cell => !cell.dataset.player);
            const randomIndex = Math.floor(Math.random() * emptyCells.length);
            const cell = emptyCells[randomIndex];
            cell.dataset.player = 'O';
            cell.innerHTML = `<img src="https://cdn.jsdelivr.net/gh/timememe/o_files@main/back_nocream.png" alt="O" class="appear">`;
        
            if (checkWin('O')) {
                roundsPlayed++;
                roundCounter.bot++;
                if (roundsPlayed >= 3) {
                    showFinalPopup();
                } else {
                    showWinPopup('O победил!');
                }
                gameActive = false;
                return;
            }
        
            if (checkDraw()) {
                roundsPlayed++;
                roundCounter.draw++;
                if (roundsPlayed >= 3) {
                    showFinalPopup();
                } else {
                    showWinPopup('Ничья!');
                }
                gameActive = false;
                return;
            }
        
            currentPlayer = 'X';
        };
        
        const restartGame = () => {
            cells.forEach(cell => {
                cell.innerHTML = '';
                cell.dataset.player = '';
            });
            currentPlayer = 'X';
            gameActive = true;
        };
        
        const startGame = () => {
            popup.style.display = 'none';
            gameActive = true;
        };
        
        const closeWinPopup = () => {
            winPopup.style.display = 'none';
            if (roundsPlayed >= 3) {
                showFinalPopup();
            } else {
                restartGame();
            }
        };
        
        const restartFullGame = () => {
            finalPopup.style.display = 'none';
            if (roundCounter.player > roundCounter.bot) {
                awardPoints(100);
            }
            roundCounter = { player: 0, bot: 0, draw: 0 };
            roundsPlayed = 0;
            restartGame();
        };
        
        function awardPoints(points) {
            const data = {
                points: points,
                reason: 'Победа в игре "Крестики-нолики"'
            };
        
            fetch('/api/mechanics/127/apply', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                console.log('Points awarded successfully:', result);
            })
            .catch(error => {
                console.error('Error awarding points:', error);
            });
        }
        
        function resizeGame() {
            const gameContainer = document.querySelector('.game-container');
            const logo = document.querySelector('.logo');
            const boardContainer = document.querySelector('.board-container');
            
            // Устанавливаем размер контейнера
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const containerWidth = Math.min(windowWidth, windowHeight * 9 / 16);
            const containerHeight = containerWidth * 16 / 9;
            
            gameContainer.style.width = `${containerWidth}px`;
            gameContainer.style.height = `${containerHeight}px`;
            
            // Устанавливаем размер логотипа
            logo.style.width = '100%';
            
            // Устанавливаем размер доски
            const boardSize = Math.min(containerWidth * 0.8, containerHeight * 0.5, 300);
            boardContainer.style.width = `${boardSize}px`;
            boardContainer.style.height = `${boardSize}px`;
        }

        cells.forEach(cell => cell.addEventListener('click', handleCellClick));
        restartButton.addEventListener('click', restartGame);
        startButton.addEventListener('click', startGame);
        closeWinPopupButton.addEventListener('click', closeWinPopup);
        restartGameButton.addEventListener('click', restartFullGame);
        window.addEventListener('load', resizeGame);
        window.addEventListener('resize', resizeGame);
        
        window.onload = () => {
            popup.style.display = 'none';
            winPopup.style.display = 'none';
            finalPopup.style.display = 'none';

            popup.style.display = 'flex';
            resizeGame(); // Вызываем один раз при загрузке
        };

        // Добавляем обработчик ошибок для изображений
        document.querySelectorAll('img').forEach(img => {
            img.onerror = function() {
                console.error('Ошибка загрузки изображения:', this.src);
            };
        });
    </script>
</body>
</html>